<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="utf-8" />
    <title>Water Level Forecast - Samut Prakan Deep Learning</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"></script>
    <script src="https://api.windy.com/assets/map-forecast/libBoot.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        body {
            margin: 0;
            font-family: 'Kanit', sans-serif;
            color: #bef0f5;
            background: linear-gradient(180deg, #a6e3f5 0%,#74b0b2 50% , #137584 75%,#26444e 100%);
            overflow: auto;
            height: 100vh;
            position: relative;
        }

        /* Background Effects */
        .bubbles {
            position: fixed;
            inset: 0;
            z-index: -1;
            pointer-events: none;
        }

        .bubble {
            position: absolute;
            bottom: -120px;
            background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.5), rgba(255, 255, 255, 0.1) 70%);
            border: 0.5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3), inset -2px -2px 5px rgba(255, 255, 255, 0.2);
            animation: rise linear infinite;
        }

        @keyframes rise {
            to {
                transform: translateY(-120vh);
                opacity: 50;
            }
        }

        /* Header */
        header {
            padding: 15px;
            text-align: center;
            position: relative;
            z-index: 10;
        }

        header h2 {
            margin: 0;
            font-size: 32px;
            font-weight: 700;
            text-shadow: 0 4px 6px rgba(145, 175, 189, 0.3);
            background: linear-gradient(to bottom, #023e54 0%, #6781a0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            position: relative;
            display: inline-block;
        }

        header h2::after {
            content: '‚ú®';
            position: absolute;
            top: -10px;
            right: -25px;
            font-size: 20px;
            animation: blink 1s infinite alternate;
            -webkit-text-fill-color: initial;
        }

        header h2::before {
            content: '‚ú®';
            position: absolute;
            bottom: 0;
            left: -25px;
            font-size: 18px;
            animation: blink 1.2s infinite alternate-reverse;
            -webkit-text-fill-color: initial;
        }

        @keyframes blink {
            from {
                opacity: 0.2;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1.2);
            }
        }

        header p {
            color: #243947;
            margin: 4px 0 0 0;
            font-size: 20px;
            font-weight: 400;
            letter-spacing: 1px;
        }

        /* Main Layout */
        #container {
            display: flex;
            gap: 16px;
            padding: 0 16px 16px 16px;
            height: calc(100vh - 170px);
            position: relative;
            z-index: 5;
        }

        #left-side {
            flex: 3;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        #top-row {
            display: flex;
            gap: 12px;
            height: 85px;
        }

        /* Control Boxes */
        .box-legend-new {
            flex: 2.5;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 10px 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .box-layers-new {
            flex: 1.5 !important;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 10px 15px !important;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            display: grid !important;
            grid-template-columns: 1fr 1fr;
            gap: 8px !important;
        }

        .box-layers-new div {
            grid-column: span 2;
        }

        .layer-title {
            font-weight: 600;
            font-size: 13px;
            color: #1e3a8a;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .layer-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }

        /* Map and Overlays */
        #windy {
            flex: 1;
            border-radius: 18px;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }

        #windy-overlay {
            position: absolute;
            inset: 0;
            z-index: 3000;
            background: #000;
            border-radius: 18px;
            display: none;
        }

        /* Info Panel */
        #info-panel {
            flex: 1;
            background: rgba(255, 255, 255, .85);
            color: #0f172a;
            backdrop-filter: blur(12px);
            box-shadow: 0 0 30px rgba(0, 0, 0, .25);
            border-radius: 18px;
            padding: 20px;
            overflow-y: auto;
        }

        /* Components */
        .legend-bar {
            display: flex;
            border-radius: 6px;
            overflow: hidden;
            height: 28px;
            border: 1px solid #ddd;
        }

        .legend-item {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 400;
            color: white;
            text-align: center;
        }

        .btn-toggle {
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            padding: 5px;
            cursor: pointer;
            font-family: 'Kanit';
            font-size: 12px;
            transition: 0.2s;
        }

        .btn-toggle.active {
            background: #0ea5e9;
            color: white;
            border-color: #0284c7;
        }

        .btn {
            width: 100%;
            margin-top: 12px;
            padding: 12px;
            border: none;
            border-radius: 14px;
            background: linear-gradient(135deg, #0369a1, #0ea5e9);
            font-weight: 600;
            cursor: pointer;
            color: white;
            transition: 0.3s;
            font-family: 'Kanit', sans-serif;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .level {
            font-size: 14px;
            margin: 6px 0;
        }

        .bank {
            color: #ef4444;
            font-weight: 600;
        }

        .bed {
            color: #0ea5e9;
            font-weight: 600;
        }

        .small {
            font-size: 13px;
            opacity: .8;
        }

        /* Modal */
        #chart-modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(8px);
            padding: 20px;
            align-items: center;
            justify-content: center;
        }

        #chart-content {
            background: white;
            width: 95%;
            max-width: 1200px;
            height: 80vh;
            border-radius: 24px;
            padding: 30px;
            position: relative;
            font-family: 'Kanit', sans-serif;
        }

        #close-chart {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 30px;
            cursor: pointer;
            color: #64748b;
            border: none;
            background: none;
        }
        /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ó‡∏±‡∏ö‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏™‡∏°‡∏≠ */
        #windy-overlay {
        pointer-events: all !important;
        }

        /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏´‡∏°‡∏∏‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡πÅ‡∏™‡∏á‡∏≠‡πà‡∏≠‡∏ô‡πÜ */
        .station-marker {
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.8));
        }

        /* ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡πÅ‡∏™‡∏á‡∏™‡∏µ‡∏ó‡∏≠‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á‡πÜ */
        .station-marker.selected .marker-pin {
            filter: drop-shadow(0 0 15px #fff700) drop-shadow(0 0 20px #ffaa00);
            transform: scale(1.2);
            transition: all 0.3s ease;
        }

    /* =======================================================
    MOBILE APP EXPERIENCE (<= 768px) ‚Äì FINAL CLEAN VERSION
    ======================================================= */

    @media (max-width: 768px) {

        /* ===== BASIC RESET ===== */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow-x: hidden;
            position: relative; 
        }

        body {
            background: linear-gradient(180deg, #a6e3f5 0%,#74b0b2 50% , #137584 75%,#26444e 100%) !important;
            background-attachment: fixed;
        }

        /* ===== HEADER ===== */
        header {
            padding: 12px;
            text-align: center;
        }

        header h2 {
            font-size: 18px;
            line-height: 1.3;
        }

        header p {
            font-size: 14px;
        }

        /* ===== MAIN STACK LAYOUT ===== */
        #container {
            display: flex;
            flex-direction: column;
            width: 96% !important; 
            margin: 0 auto;         
            gap: 10px;
            padding: 0;
            position: relative;
            z-index: 5;            
        }

        #left-side {
            display: flex;
            flex-direction: column;
            flex: none; 
            gap: 10px;
            width: 100%;
            height: 100%; 
        }

        /* ===== TOP CONTROLS (STACKED) ===== */
        #top-row {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 0;
            height: auto;
            width: 100%;
        }

        /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Å‡∏ß‡πâ‡∏≤‡∏á 94% ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏Ç‡∏≠‡∏ö‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏õ‡πä‡∏∞ */
        .box-legend-new,
        .box-layers-new,
        #windy {
            width: 96% !important;
            margin: 0 auto !important;
            box-sizing: border-box; 
            flex: none;
        }

        .box-legend-new,
        .box-layers-new {
            padding: 12px;
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.95);
        }

        /* ‡∏Ñ‡πà‡∏≤‡∏î‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ */
        .legend-bar { height: 24px; }
        .legend-item { font-size: 11px; }
        .btn-toggle { font-size: 12px; padding: 8px; }

        /* ===== MAP (‡∏¢‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏ö‡∏µ‡∏¢‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠) ===== */
        #windy {
            height: 52vh; /* ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏™‡∏±‡πâ‡∏ô‡∏•‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏£‡∏ö‡πÉ‡∏ô‡∏à‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏ß */
            min-height: 260px;
            border-radius: 14px;
        }

        /* ===== INFO PANEL (BOTTOM SHEET) ===== */
        #info-panel {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            bottom: -45vh;
            width: 94%;
            height: 45vh;

            padding: 14px;
            background: rgba(255,255,255,0.96);
            backdrop-filter: blur(10px);
            border-radius: 20px 20px 0 0;

            z-index: 9000;
            overflow-y: auto;
            transition: bottom 0.3s ease;
        }

        #info-panel.show {
            bottom: 0;
        }

        /* ===== CHART (FULLSCREEN ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏û‡∏±‡∏á UI) ===== */
        #chart-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: #ffffff;
            z-index: 10000;
            padding: 0;
        }

        #chart-content {
            width: 100%;
            height: 100%;
            padding: 16px 12px 20px;
            box-sizing: border-box;
            border-radius: 0;
            overflow: hidden;
        }

        #chart {
            width: 100% !important;
            height: calc(100% - 60px) !important; /* ‚¨ÖÔ∏è ‡∏Å‡∏±‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏≤‡∏¢ */
        }

        #close-chart {
            top: 10px;
            right: 14px;
            font-size: 28px;
        }
    }

    </style>

</head>

<body>

    <div class="bubbles" id="bubbles"></div>

    <header>
        <h2>‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£</h2>
        <p>‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÇ‡∏î‡∏¢‡πÇ‡∏Ñ‡∏£‡∏á‡∏Ç‡πà‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ó‡πÄ‡∏ó‡∏µ‡∏¢‡∏°‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å</p>
    </header>

    <div id="container">
        <div id="left-side">
            <div id="top-row">
                <div class="box-legend-new">
                    <div style="margin-bottom: 5px; font-weight: 600; font-size: 13px; color: #1e3a8a;">üìâ(% ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏‡∏•‡∏≥‡∏ô‡πâ‡∏≥)</div>
                    <div class="legend-bar">
                        <div style="background: #fb923c;" class="legend-item">‡∏ô‡πâ‡∏≠‡∏¢‡∏ß‡∏¥‡∏Å‡∏§‡∏ï (&le;10)</div>
                        <div style="background: #fde047; color: #333;" class="legend-item">‡∏ô‡πâ‡∏≠‡∏¢ (10-30)</div>
                        <div style="background: #22c55e;" class="legend-item">‡∏õ‡∏Å‡∏ï‡∏¥ (30-70)</div>
                        <div style="background: #3b82f6;" class="legend-item">‡∏°‡∏≤‡∏Å (70-100)</div>
                        <div style="background: #ef4444;" class="legend-item">‡∏•‡πâ‡∏ô‡∏ï‡∏•‡∏¥‡πà‡∏á (>100)</div>
                    </div>
                </div>

                <div class="box-layers-new">
                    <div class="layer-grid">
                        <button id="tog-gistda" class="btn-toggle active" onclick="toggleGistdaLayer()">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°‡∏ã‡πâ‡∏≥‡∏ã‡∏≤‡∏Å</button>
                        <button id="btn-osm" class="btn-toggle" onclick="changeBaseMap('osm')">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏ô‡∏ô</button>
                        <button id="btn-sat" class="btn-toggle" onclick="changeBaseMap('satellite')">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°</button>
                    </div>
                </div>
            </div>

            <div id="windy" style="position: relative;">
                
            </div>
        </div>

        <div id="info-panel">
            <div style="margin-bottom: 15px;">
                <input type="text" id="st-search" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ..." style="width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #cbd5e1; font-family: 'Kanit'; box-sizing: border-box;">
                <div id="search-results" style="background: white; border-radius: 0 0 10px 10px; max-height: 150px; overflow-y: auto; display: none; position: absolute; width: calc(100% - 40px); z-index: 100; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>
            </div>
            <hr style="border:0; border-top:1px solid #e2e8f0; margin:10px 0;">
            <div id="info-empty" style="text-align: center; padding-top: 50px; color: #64748b;">üìç ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</div>
            <div id="info-content" style="display:none">
                <h3 id="st-name" style="margin-top:0; color:#0369a1; font-size: 20px;"></h3>
                <div class="small">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ: <span id="st-code"></span></div>
                <div id="info-date" class="small" style="color:#0369a1; font-weight:600; margin-top:5px;"></div>
                <hr style="border:0; border-top:1px solid #e2e8f0; margin:15px 0;">

                <div style="background: rgba(255,255,255,0.6); padding: 12px; border-radius: 12px; margin-bottom: 12px; border: 1px solid #e2e8f0;">
                    <div class="level">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á: <b id="st-status-text"></b></div>
                    <div class="level">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥ (‡∏°.‡∏£‡∏ó‡∏Å.): <b id="st-water-val" style="color:#1e40af;">-</b></div>
                    <div class="level">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏‡∏•‡∏≥‡∏ô‡πâ‡∏≥: <b id="st-pct-text" style="font-size: 20px; color:#1e40af;"></b></div>
                </div>

                <div class="level bank">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡∏•‡∏¥‡πà‡∏á: <span id="st-bank"></span> ‡∏°. (‡∏£‡∏ó‡∏Å.)</div>
                <div class="level bed">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ó‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥: <span id="st-bed"></span> ‡∏°. (‡∏£‡∏ó‡∏Å.)</div>
                <div class="level small">‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ: <b id="st-model" style="color:#0ea5e9;"></b></div>

                <button class="btn" onclick="openChartModal()" style="font-size: 16px; height: 55px; box-shadow: 0 4px 15px rgba(2, 132, 199, 0.3);">
                    üìä ‡∏î‡∏π‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤
                </button>

                <button class="btn" style=" background:#6a8395; margin-top:20px;box-shadow: 0 4px 15px rgba(90, 99, 104, 0.3);"
                        onclick="openWindy()">Windy.com üåß
                </button>

                <div style="margin-top:20px;">
                    <label class="small">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°‡∏ã‡πâ‡∏≥‡∏ã‡∏≤‡∏Å</label>
                    <input type="range" min="0" max="1" step="0.1" value="0.5" style="width:100%" oninput="updateFloodOpacity(this.value)">
                </div>
            </div>
        </div>
    </div>
        <div
        id="windy-overlay"
        style="
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 9999;
        "
    >
        <div
            style="
                position: relative;
                width: 90%;
                height: 90%;
                margin: 2% auto;
                background: #fff;
                border-radius: 15px;
                overflow: hidden;
                box-shadow: 0 0 20px rgba(0,0,0,0.5);
            "
        >
            <button
                onclick="closeWindy()"
                style="
                    position: absolute;
                    top: 12px;
                    left: 12px;
                    z-index: 10001;
                    padding: 9px 19px;
                    background: #ef4444;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    font-family: 'Kanit';
                    font-weight: bold;
                "
            >
                ‡∏õ‡∏¥‡∏î X
            </button>

            <iframe
                id="windy-frame"
                width="100%"
                height="100%"
                frameborder="0"
            ></iframe>
        </div>
    </div>

    <p
        style="
            font-size: 12.5px;
            color: #d6e3f5;
            margin-top: 10px;
            text-align: left;
            padding-left: 20px;
            opacity: 0.9;
            font-weight: 300;
            letter-spacing: 0.5px;
        "
    >
        <i class="fas fa-info-circle"></i>
        <b>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ :</b>
        ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏•‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏ö‡∏ö‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå
        ‡∏°‡∏¥‡πÉ‡∏ä‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡∏±‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå
    </p>
    

    <div id="chart-modal">
        <div id="chart-content">
            <button id="close-chart" onclick="closeChartModal()">&times;</button>
            <h3 id="modal-st-name" style="margin: 0 0 10px 0; color: #0369a1;"></h3>
            <div style="height: 85%;">
                <canvas id="chart"></canvas>
            </div>
            <div class="small" style="text-align:center; margin-top:15px; color:#64748b; font-family: 'Kanit', sans-serif;">
                üñ±Ô∏è ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡∏ö‡∏ô‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡πÜ | ‡∏•‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤

            <button class="btn" onclick="exportChart()" 
                style="
                    display: block; 
                    width: 100%; 
                    height: 25px; 
                    line-height: 25px; 
                    padding: 0; 
                    font-size: 12px; 
                    text-align: center; 
                    border-radius: 4px;
                    box-shadow: 0 1px 5px rgba(2, 132, 199, 0.3);
                ">
                üíæ Export ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ
            </button>

            </div>
        </div>
    </div>
</body>

 
    <script>
        // Global Variables
        let currentChartData = [];
        let currentStation = null, chart = null, floodWMTS, provinceLayer, windyStore;
        let map;
        let baseLayers = {};
        let activeBaseLayer = null;
        let selectedMarker = null; 
        let allStations = [];
        let osmLayer = null;
        let satLayer = null;
        let isWindyActive = true;
        let activeOverlay = null;
  
        const options = {
            key: 'myPD7Kp6ct2f3k0X6jxKDPYmQy1f5rs6', // replace with your Windy API key           
            verbose: false,
            lat: 13.62,
            lon: 100.70,
            zoom: 11,
        };

// ===== ‡∏™‡∏£‡πâ‡∏≤‡∏á Leaflet Map ‡∏õ‡∏Å‡∏ï‡∏¥ =====
map = L.map('windy').setView([13.62, 100.70], 10);

// Base Maps
osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
}).addTo(map);

satLayer = L.tileLayer(
    'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
    { maxZoom: 19 }
);

// GISTDA Layer
floodWMTS = L.tileLayer(
    "https://gistdaportal.gistda.or.th/data/rest/services/FL_Flood/FL_RepeatedFlooding_GISTDA_50k_Y2005_Y2016/MapServer/WMTS/tile/1.0.0/FL_Flood_FL_RepeatedFlooding_GISTDA_50k_Y2005_Y2016/default/GoogleMapsCompatible/{z}/{y}/{x}.png",
    {
        opacity: 0.5,
        zIndex: 500
    }
).addTo(map);


            // ‡∏î‡∏∂‡∏á GeoJSON
            fetch('samutprakan.geojson').then(r => r.json()).then(geoData => {
                provinceLayer = L.geoJSON(geoData, {
                    style: { color: "#ff6a14", weight: 4, fillOpacity: 0, dashArray: "10, 10" },
                    interactive: false
                }).addTo(map);
            });

            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ
            fetch('stations_forecast_full.json').then(r => r.json()).then(data => {
                allStations = Object.values(data);
                allStations.forEach(st => {
                    const color = getColorByStatus(st.test[st.test.length - 1].Status);
                    const marker = L.marker([st.lat, st.lon], {
                        icon: L.divIcon({ 
                            className: 'station-marker', 
                            html: `
                            <svg width="20" height="30" viewBox="0 0 30 42" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M15 42C15 42 30 25.4545 30 15C30 6.71573 23.2843 0 15 0C6.71573 0 0 6.71573 0 15C0 25.4545 15 42 15 42Z" fill="${color}"/>
                            <circle cx="15" cy="15" r="6" fill="white"/>
                            </svg>`, 
                            iconSize: [20, 30], 
                            iconAnchor: [10, 30]
                        })
                    }).addTo(map);

                    marker.on("click", () => {
                        if (selectedMarker) { 
                            selectedMarker.getElement()?.querySelector('path')?.setAttribute('stroke', 'none');
                        }
                        marker.getElement()?.querySelector('path')?.setAttribute('stroke', 'black');
                        marker.getElement()?.querySelector('path')?.setAttribute('stroke-width', '2');
                        selectedMarker = marker;
                        openStationPanel(st);
                    });
                });
            }).catch(err => console.error("Error loading stations:", err));


        const searchInput = document.getElementById('st-search');
        const searchResults = document.getElementById('search-results');

            searchInput.addEventListener('input', (e) => {
                const val = e.target.value.toLowerCase();
                searchResults.innerHTML = '';
                if (!val) { searchResults.style.display = 'none'; return; }

                const matched = allStations.filter(s =>
                    s.station_th.toLowerCase().includes(val) ||
                    s.station.toLowerCase().includes(val)
                );

                matched.forEach(s => {
                    const div = document.createElement('div');
                    div.style.padding = '8px 12px';
                    div.style.cursor = 'pointer';
                    div.style.borderBottom = '1px solid #eee';
                    div.innerHTML = `<b>${s.station}</b> - ${s.station_th}`;
                    div.onclick = () => {
                        map.flyTo([s.lat, s.lon], 13);
                        openStationPanel(s);
                        searchResults.style.display = 'none';
                        searchInput.value = s.station_th;
                    };
                    searchResults.appendChild(div);
                });
                searchResults.style.display = matched.length ? 'block' : 'none';
            });

        function changeBaseMap(type) {
            if (!map || !osmLayer || !satLayer) return;

                const btnOsm = document.getElementById('btn-osm');
                const btnSat = document.getElementById('btn-sat');
                const btnWindy = document.getElementById('tog-windy');

            if (type === 'osm') {
            if (map.hasLayer(osmLayer)) {
                // --- ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‡∏Å‡∏î‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏° ‡∏ñ‡∏ô‡∏ô ---
                map.removeLayer(osmLayer); // ‡∏î‡∏∂‡∏á‡πÅ‡∏ú‡πà‡∏ô OSM ‡∏≠‡∏≠‡∏Å
                btnOsm?.classList.remove('active');
            
                // ‡∏™‡∏±‡πà‡∏á Windy ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå Overlay (‡∏•‡∏°/‡∏ù‡∏ô) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ
                btnWindy?.classList.add('active');
                isWindyActive = true;
            } else {
                // ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡πà‡∏ô OSM ‡∏°‡∏≤‡∏ó‡∏±‡∏ö Windy
                if (map.hasLayer(satLayer)) map.removeLayer(satLayer);
                map.addLayer(osmLayer);
                btnOsm?.classList.add('active');
                btnSat?.classList.remove('active');
            
                // ‡∏õ‡∏¥‡∏î‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå Windy ‡πÑ‡∏õ (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ñ‡∏ô‡∏ô‡∏ö‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà)
                btnWindy?.classList.remove('active');
                isWindyActive = false;
            }
            } else if (type === 'satellite') {
                if (map.hasLayer(satLayer)) {
                // --- ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‡∏Å‡∏î‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏° ‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏° ---
                map.removeLayer(satLayer); // ‡∏î‡∏∂‡∏á‡πÅ‡∏ú‡πà‡∏ô Satellite ‡∏≠‡∏≠‡∏Å
                btnSat?.classList.remove('active');
            
                windyStore.set('overlay', 'wind'); 
                btnWindy?.classList.add('active');
                isWindyActive = true;
            } else {
            // ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡πà‡∏ô Satellite ‡∏°‡∏≤‡∏ó‡∏±‡∏ö
                if (map.hasLayer(osmLayer)) map.removeLayer(osmLayer);
                map.addLayer(satLayer);
                btnSat?.classList.add('active');
                btnOsm?.classList.remove('active');
            
                windyStore.set('overlay', 'none');
                btnWindy?.classList.remove('active');
                isWindyActive = false;
                }
            }
        }

        function openWindy() {
            if (!currentStation) {
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô");
            return;
            }

            const overlay = document.getElementById("windy-overlay");
            const frame = document.getElementById("windy-frame");

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡πÇ‡∏î‡∏¢‡∏î‡∏∂‡∏á lat, lon ‡∏à‡∏≤‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            const url = `https://embed.windy.com/embed2.html?lat=${currentStation.lat}&lon=${currentStation.lon}&zoom=11&level=surface&overlay=rain&product=ecmwf&menu=&message=true&marker=true&calendar=now&pressure=true&type=map&location=coordinates&detail=true&metricWind=default&metricTemp=default&radarRange=-1`;

            frame.src = url;
            overlay.style.display = "block"; // ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á Windy
        }

        function closeWindy() {
            const overlay = document.getElementById("windy-overlay");
            const frame = document.getElementById("windy-frame");
    
            if (overlay) {
                overlay.style.display = "none";
            }
            if (frame) {
                frame.src = ""; // ‡∏•‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î iframe
            }
        }

        function toggleGistdaLayer() {
            const btn = document.getElementById('tog-gistda');
            if (map.hasLayer(floodWMTS)) {
                map.removeLayer(floodWMTS);
                btn.classList.remove('active');
            } else {
                map.addLayer(floodWMTS);
                btn.classList.add('active');
            }
        }

        function updateFloodOpacity(v) {
            if (floodWMTS) floodWMTS.setOpacity(v);
        }

        // Station Panel & Data Functions
        function openStationPanel(st) {
            currentStation = st;
            const latest = [...st.test].sort((a, b) => new Date(b.date) - new Date(a.date))[0];

            document.getElementById("info-empty").style.display = "none";
            document.getElementById("info-content").style.display = "block";
            document.getElementById("info-date").innerText = "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: " + latest.date;
            document.getElementById("st-name").innerText = st.station_th;
            document.getElementById("st-code").innerText = st.station;
            document.getElementById("st-bank").innerText = st.bank_level_m.toFixed(2);
            document.getElementById("st-bed").innerText = st.bed_level_m.toFixed(2);
            document.getElementById("st-model").innerText = st.best_model;
            document.getElementById("st-status-text").innerText = latest.Status;

            const waterVal = latest.Actual !== undefined && latest.Actual !== null ? latest.Actual : latest.Predicted;
            document.getElementById("st-water-val").innerText = waterVal.toFixed(2) + " ‡∏°.";
            document.getElementById("st-pct-text").innerText = latest["Predicted_%"].toFixed(2) + " %";
            document.getElementById("st-status-text").style.color = getColorByStatus(latest.Status);
        }

        function getColorByStatus(s) {
            if (!s) return "#ccc";
            if (s.includes("‡∏•‡πâ‡∏ô‡∏ï‡∏•‡∏¥‡πà‡∏á")) return "#ef4444";
            return s.includes("‡∏ô‡πâ‡∏≥‡∏°‡∏≤‡∏Å") ? "#3b82f6" : s.includes("‡∏õ‡∏Å‡∏ï‡∏¥") ? "#22c55e" : s.includes("‡∏ô‡πâ‡∏≠‡∏¢‡∏ß‡∏¥‡∏Å‡∏§‡∏ï") ? "#fb923c" : "#fde047";
        }

        // Chart Modal Functions
        function openChartModal() {
            if (!currentStation) return;
            document.getElementById("chart-modal").style.display = "flex";
            document.getElementById("modal-st-name").innerText = "‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ: " + currentStation.station_th;
            drawChart(currentStation);
        }

        function closeChartModal() {
            document.getElementById("chart-modal").style.display = "none";
        }

        window.addEventListener('keydown', (e) => {
            if (e.key === "Escape") closeChartModal();
        });

        function drawChart(st) {
            const ctx = document.getElementById("chart").getContext("2d");
            if (chart) chart.destroy();

            const sortedData = [...st.test].sort((a, b) => new Date(a.date) - new Date(b.date));
            const labels = sortedData.map(d => d.date);
            currentChartData = sortedData;

            const actual = sortedData.map(d => (d.date <= "2025-10-31") ? d.Actual : null);
            const forecast = sortedData.map(d => (d.date >= "2025-11-01") ? d.Predicted : null);

            const bank = st.bank_level_m;
            const bed = st.bed_level_m;

            chart = new Chart(ctx, {
                type: "line",
                data: {
                    labels: labels,
                    datasets: [{
                            label: "‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏à‡∏£‡∏¥‡∏á",
                            data: actual,
                            borderColor: "#1e40af",
                            borderWidth: 3,
                            pointRadius: 5,
                            hitRadius: 10,
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: "‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ (‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô)",
                            data: forecast,
                            borderColor: "#f97316",
                            backgroundColor: "#f97316",
                            pointRadius: 5,
                            hitRadius: 10,
                            showLine: true,
                            borderDash: [5, 5],
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (evt, elements) => {
                        if (!elements.length) return;
                        const idx = elements[0].index;
                        const d = currentChartData[idx];
                        if (!d) return;

                        document.getElementById("info-date").innerText = "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: " + d.date;
                        document.getElementById("st-status-text").innerText = d.Status;
                        document.getElementById("st-status-text").style.color = getColorByStatus(d.Status);

                        const waterVal = d.Actual !== undefined && d.Actual !== null ? d.Actual : d.Predicted;
                        document.getElementById("st-water-val").innerText = waterVal.toFixed(2) + " ‡∏°.";

                        const pct = d["Predicted_%"] !== undefined ? d["Predicted_%"] : ((waterVal - bed) / (bank - bed) * 100);
                        document.getElementById("st-pct-text").innerText = pct.toFixed(2) + " %";
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const idx = context.dataIndex;
                                    const d = currentChartData[idx];
                                    const label = context.dataset.label || '';
                                    const val = context.parsed.y;
                                    let lines = [`${label}: ${val.toFixed(2)} ‡∏°.`];
                                    if (d) {
                                        lines.push(`‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á: ${d.Status}`);
                                        const pct = d["Predicted_%"] !== undefined ? d["Predicted_%"] : ((val - bed) / (bank - bed) * 100);
                                        lines.push(`‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏‡∏•‡∏≥‡∏ô‡πâ‡∏≥: ${pct.toFixed(2)} %`);
                                    }
                                    return lines;
                                }
                            }
                        },
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    family: 'Kanit',
                                    size: 14
                                }
                            }
                        },
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'x'
                            },
                            zoom: {
                                wheel: {
                                    enabled: true
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'x'
                            }
                        },
                        annotation: {
                            annotations: {
                                lineBank: {
                                    type: 'line',
                                    yMin: bank,
                                    yMax: bank,
                                    borderColor: 'red',
                                    borderWidth: 2,
                                    borderDash: [6, 6],
                                    label: {
                                        display: true,
                                        content: '‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡∏•‡∏¥‡πà‡∏á ' + bank,
                                        position: 'end',
                                        backgroundColor: 'red',
                                        font: {
                                            family: 'Kanit'
                                        }
                                    }
                                },
                                lineBed: {
                                    type: 'line',
                                    yMin: bed,
                                    yMax: bed,
                                    borderColor: 'black',
                                    borderWidth: 2,
                                    borderDash: [6, 6],
                                    label: {
                                        display: true,
                                        content: '‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ó‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥ ' + bed,
                                        position: 'end',
                                        backgroundColor: 'black',
                                        font: {
                                            family: 'Kanit'
                                        }
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'category',
                            min: "2025-10-25",
                            ticks: {
                                font: {
                                    family: 'Kanit'
                                },
                                autoSkip: true,
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            min: bed - 0.2,
                            suggestedMax: bank + 1.0,
                            title: {
                                display: true,
                                text: '‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥ (‡∏°.‡∏£‡∏ó‡∏Å.)',
                                font: {
                                    family: 'Kanit'
                                }
                            }
                        }
                    }
                }
            });
        }

        function exportChart() {
            if (!chart) return;
            const link = document.createElement('a');
            link.download = 'water-forecast.png';
            link.href = chart.toBase64Image();
            link.click();
        }

        // Bubble Animation Generator
        const bc = document.getElementById("bubbles");
        for (let i = 0; i < 20; i++) {
            const b = document.createElement("div");
            b.className = "bubble";
            b.style.width = b.style.height = (10 + Math.random() * 35) + "px";
            b.style.left = Math.random() * 100 + "%";
            b.style.animationDuration = (5 + Math.random() * 10) + "s";
            b.style.animationDelay = Math.random() * 4 + "s";
            bc.appendChild(b);
        }

        // === Mobile: ‡πÄ‡∏õ‡∏¥‡∏î info panel ‡πÅ‡∏ö‡∏ö bottom sheet ===
    const originalOpenStationPanel = openStationPanel;

    openStationPanel = function(st) {
        originalOpenStationPanel(st);

        if (window.innerWidth <= 768) {
            const panel = document.getElementById("info-panel");
            panel.classList.add("show");
        }
    };

    // === ‡∏õ‡∏¥‡∏î info panel ‡∏î‡πâ‡∏ß‡∏¢ swipe ‡∏•‡∏á ===
    let startY = 0;
    const panel = document.getElementById("info-panel");

    panel.addEventListener("touchstart", e => {
        startY = e.touches[0].clientY;
    }, { passive: true });

    panel.addEventListener("touchend", e => {
        const dy = e.changedTouches[0].clientY - startY;
        if (dy > 100) {
            panel.classList.remove("show");
        }
    }, { passive: true });

    </script>
</body>

</html>
